<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
<title>A Contagem da Rosa ‚Äî Cinem√°tica</title>
<meta name="color-scheme" content="dark" />

<style>
:root{
  --bg-deep:#06050a;
  --nebula-1: rgba(91,35,96,0.12);
  --nebula-2: rgba(134,54,131,0.08);
  --accent:#d8b3f1;
  --accent-2:#f6d7b1;
  --muted:#f0e9f6;
  --card-bg: rgba(255,255,255,0.035);
  --glass: rgba(255,255,255,0.05);
  --glass-strong: rgba(255,255,255,0.07);
  --gold-glow: rgba(212,160,255,0.12);
}

*{ box-sizing:border-box; }
html,body{ height:100%; margin:0; font-family:Inter,system-ui,-apple-system,Roboto,Helvetica,Arial; color:var(--muted);
  background:
    radial-gradient(1200px 700px at 12% 10%, var(--nebula-1), transparent 22%),
    radial-gradient(900px 500px at 90% 75%, var(--nebula-2), transparent 18%),
    linear-gradient(180deg, var(--bg-deep) 0%, #0b0b12 100%);
  -webkit-font-smoothing:antialiased;
  -webkit-text-size-adjust:100%;
  overscroll-behavior:none;
}
.wrap{ width:100%; max-width:1100px; margin:0 auto; padding:24px 18px 120px; position:relative; z-index:10; }
header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }

/* title */
.title h1{ margin:0; font-size:22px; font-weight:600; }
.subtitle{ margin-top:6px; font-size:13px; opacity:0.78; }

/* controls area */
.controls{ display:flex; gap:12px; align-items:center; }
.count{ background:var(--glass); padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); font-size:13px; backdrop-filter:blur(4px); display:flex; flex-direction:column; align-items:flex-start; min-width:170px; }
.count .num{ font-weight:700; color:var(--accent); margin-top:4px; }

/* ===== ICON BUTTONS ‚Äî vers√£o refinada ===== */
.icon-btn{
  width:28px;
  height:28px;
  border-radius:50%;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.07);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  padding:0;
  transition:background .25s ease, border-color .25s ease;
}

.icon-btn svg{
  width:16px;
  height:16px;
}


.icon-btn:hover{
  background:rgba(255,255,255,0.16);
  border-color:rgba(255,255,255,0.22);
  transform:translateY(-1px);
}

.controls-mini{
  display:flex;
  align-items:center;
  gap:10px;
  padding-left:4px;
}



/* PLAYER ‚Äì VERS√ÉO CORRETA (substituir a duplicada) */
.player{
  display:flex;
  align-items:center;
  gap:18px;
  background:rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.06);
  padding:12px 16px;
  border-radius:20px;
  min-width:300px;
  max-width:390px;
  backdrop-filter: blur(12px);
  position:relative;
  transition:all .25s ease;
  box-shadow:0 8px 24px rgba(0,0,0,0.45);
}

.player .cover{
  width:60px;
  height:60px;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 8px 18px rgba(0,0,0,0.5);
}

.player .cover img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.player .meta{
  display:flex;
  flex-direction:column;
  gap:4px;
  flex-grow:1;
  min-width:0;
}

.player .title{
  font-size:15px;
  font-weight:600;
  letter-spacing:0.2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.player .sub{
  font-size:12px;
  opacity:0.78;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}


/* iPhone optimization */
@media (max-width:480px){
  #playerCard{
    max-width:100%;
    width:100%;
    padding:12px 14px;
    border-radius:18px;
    gap:12px;
  }
}


/* lock overlay */
.player .lockBadge{
  position:absolute; right:8px; top:8px; font-size:11px; padding:6px 8px; border-radius:999px;
  background:rgba(0,0,0,0.36); border:1px solid rgba(255,255,255,0.03); display:flex; gap:6px; align-items:center; color:var(--muted);
}

/* tiny glow when unlocked */
.player.unlocked{ box-shadow:0 8px 30px var(--gold-glow); border-color: rgba(212,160,255,0.06); }

/* modal album box tweaks */
#albumBox img{ width:180px; height:180px; border-radius:12px; object-fit:cover; }

/* toast */
.toast{ position:fixed; left:50%; transform:translateX(-50%) translateY(20px); bottom:28px; padding:10px 14px; border-radius:12px; background:rgba(0,0,0,0.65); opacity:0; color:var(--muted); transition:all .22s; z-index:300; }
.toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

/* minimal responsive */
/* ================= GRID (restaura espa√ßamento e estilo dos cards) ================ */
main.grid{
  margin-top:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(115px,1fr));
  gap:18px;
  touch-action:manipulation;
}


.day{
  aspect-ratio:1;
  border-radius:16px;
  background:linear-gradient(180deg, rgba(255,255,255,0.045), rgba(255,255,255,0.018));
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  position:relative;
  overflow:hidden;
  box-shadow:0 6px 22px rgba(0,0,0,0.55);
  transition:transform .25s cubic-bezier(.2,.9,.2,1), box-shadow .25s ease;
}


.day.enter{
  animation:cardIn .55s cubic-bezier(.2,.9,.2,1) forwards;
}
@keyframes cardIn{
  0%{ opacity:0; transform:translateY(28px) scale(.94); }
  100%{ opacity:1; transform:none; }
}

/* --- Corre√ß√µes de uniformidade do grid --- */

/* Remove transform inicial que deixava cards em tamanhos irregulares */
.day {
  transform: none !important;
}

/* Mant√©m o glow mas reduz para n√£o parecer que o card cresce */
.day.checked{
  box-shadow:0 10px 28px rgba(212,160,255,0.12);
}

/* locked mais consistente visualmente */
.day.locked{
  filter:grayscale(18%);
  opacity:0.85;
}

/* C√≠rculo fixo para todos os estados */
.circle{
  width:60px;
  height:60px;
  border-radius:50%;
  background:
    radial-gradient(circle at 40% 30%, rgba(255,255,255,.22), rgba(255,255,255,.05) 62%, rgba(255,255,255,.03)),
    rgba(255,255,255,0.03);
  border:1px solid rgba(255,255,255,0.08);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:19px;
  font-weight:600;
  color:var(--muted);
  box-shadow:0 3px 14px rgba(0,0,0,0.45);
  backdrop-filter: blur(6px);
}




.label{
  margin-top:8px; font-size:12px; opacity:0.92;
  text-align:center; padding:0 6px;
}



.day .check{
  position:absolute;
  right:10px;
  top:10px;
  width:26px;
  height:26px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(246,215,166,0.9); /* gold soft */
  color:#1a0f20;
  font-weight:700;
  font-size:14px;
  transform:scale(0);
  box-shadow:0 3px 12px rgba(0,0,0,.35);
  transition:transform .22s cubic-bezier(.2,.9,.2,1);
}

.day.checked .check{ transform:scale(1); }

/* desktop hover */
@media (hover:hover){
  .day:hover{
  transform:translateY(-6px) scale(1.02);
  box-shadow:0 18px 42px rgba(0,0,0,0.65);
}

}

/* responsive tweak */
@media (max-width:720px){
  main.grid{
    grid-template-columns:repeat(3,1fr);
    gap:14px;
    padding-bottom:40px;
  }
  .circle{
    width:56px;
    height:56px;
    font-size:17px;
  }
}



</style>
</head>
<body>

<canvas id="aurora" style="position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:3"></canvas>
<canvas id="stars"  style="position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:2"></canvas>
<canvas id="snow"   style="position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:4"></canvas>

<div class="wrap" role="main">
  <header>
    <div class="title">
      <h1>üåô A Contagem da Rosa</h1>
      <div class="subtitle">H√° magias que n√£o precisam de feiti√ßos ‚Äî s√≥ do tempo certo para florescer.</div>
    </div>

    <div style="display:flex;align-items:center;gap:12px;">
      <div class="controls" aria-hidden="false">
        <div class="count" aria-live="polite">
          <div style="font-size:12px;opacity:0.72">Contagem at√© 17 de Dezembro</div>
          <div class="num" id="cdText">-- dias --</div>
        </div>

        <!-- PLAYER next to the counter -->
        <div id="playerCard" class="player" aria-live="polite" title="Player">
          <div class="cover" id="playerCover">
            <!-- default blank cover -->
            <img id="playerCoverImg" src="" alt="Capa" style="opacity:0;">
          </div>

          <div class="meta">
            <div class="title" id="playerTrackTitle">Trilha bloqueada</div>
            <div class="sub" id="playerTrackArtist">‚Äî</div>
          </div>

          <div class="controls-mini" aria-hidden="false" style="margin-left:8px">
            <button id="playerPrev" class="icon-btn" title="Anterior" aria-label="Anterior">
              <!-- SVG prev -->
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M19 18L11 12l8-6v12zM5 6v12"/></svg>
            </button>

            <button id="playerPlay" class="icon-btn" title="Tocar" aria-label="Tocar">
              <!-- SVG play -->
              <svg id="playerPlayIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M5 3v18l15-9L5 3z"/></svg>
            </button>

            <button id="playerNext" class="icon-btn" title="Pr√≥xima" aria-label="Pr√≥xima">
              <!-- SVG next -->
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M5 6l8 6-8 6V6zm14 0v12"/></svg>
            </button>
          </div>

          <div class="lockBadge" id="playerLockBadge" style="display:flex;align-items:center;gap:6px;">
            <!-- SVG lock -->
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <span style="font-size:12px;opacity:0.88">Trilha bloqueada</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- grid and content (unchanged, will be populated by script) -->
  <main id="grid" class="grid" aria-label="Calend√°rio do advento"></main>
  <div style="margin-top:18px;font-size:14px;opacity:0.65;">Oi, meu bem...</div>
</div>

<!-- MODAL (mantive sua estrutura, ajustei para sempre mostrar m√∫sica quando desbloqueado) -->
<div class="modalBack" id="modalBack" aria-hidden="true" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,3,6,0.55),rgba(2,3,6,0.85));z-index:220;padding:18px;">
  <div class="modal" id="modal" role="dialog" aria-modal="true" style="width:100%;max-width:760px;border-radius:16px;padding:22px 20px;background:linear-gradient(180deg, rgba(10,8,18,0.86), rgba(20,12,30,0.97));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(10px);box-shadow:0 28px 80px rgba(0,0,0,0.70);">
    <button id="closeModal" style="float:right;background:none;border:0;color:var(--muted);font-size:20px;cursor:pointer">‚úï</button>
    <h2 id="modalTitle" style="margin:0 0 10px 0;color:var(--accent)">Dia</h2>
    <div id="modalBody"><p id="modalText" style="line-height:1.65;font-size:15px;white-space:pre-line;">carregando...</p></div>

    <!-- CAPA DO √ÅLBUM (modal) -->
    <div id="albumBox" style="display:none;margin-top:18px;text-align:center;">
      <img id="albumArt" src="" alt="Capa do √°lbum" style="width:180px;height:180px;object-fit:cover;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.45);opacity:0;transition:opacity .45s ease;">
      <div id="albumTitle" style="margin-top:10px;font-size:16px;opacity:0.95;color:var(--accent);"></div>
    </div>

    <div id="extraMusicBox" style="display:none;margin-top:16px;">
      <div style="display:flex;gap:8px;align-items:center;justify-content:center;">
        <button id="modalPrev" class="btn ghost" style="padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted)">‚èÆ</button>
        <button id="modalPlay" class="btn primary" style="padding:8px 12px;border-radius:8px;background:linear-gradient(180deg,var(--accent),#b58ad8);border:0;color:#09040d;font-weight:700">‚ñ∂</button>
        <button id="modalNext" class="btn ghost" style="padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted)">‚è≠</button>
      </div>
    </div>

    <div class="passwordBox" id="passwordBox" style="margin-top:18px;">
      <label style="display:block;margin-bottom:6px;opacity:0.8">Senha do dia</label>
      <input id="passwordInput" type="password" placeholder="Digite a senha" aria-label="Senha do dia" inputmode="text" style="width:100%;padding:12px;border-radius:10px;background:rgba(255,255,255,0.05);border:0;color:var(--muted)" />
    </div>

    <div style="height:10px"></div>
    <div id="hintContainer"><label style="display:block;margin-bottom:6px;opacity:0.8">Dica</label><div class="hintBox" id="hintBox" aria-live="polite" style="background:rgba(255,255,255,0.04);border-radius:10px;padding:12px;min-height:60px;"></div></div>

    <div class="btnRow" style="margin-top:14px;display:flex;gap:12px;justify-content:flex-end;">
      <button class="btn ghost" id="btnClose" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:10px 14px;border-radius:10px;">Fechar</button>
      <button class="btn primary" id="btnConfirm" style="background:linear-gradient(180deg,var(--accent),#b58ad8);color:#09040d;font-weight:700;padding:10px 14px;border-radius:10px;border:0;">Confirmar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">‚úî Senha correta</div>

<!-- AUDIO: player-specific audio (global player) -->
<audio id="playerAudio" preload="auto"></audio>

<script>
/* ========== Dados originais (dias) ========== */
const days = [
  {
    index: 1,
    date: "2025-11-17",
    label: "17/11",
    text_before:
      "Toda hist√≥ria tem um ponto onde o destino respira mais fundo.\n" +
      "O nosso‚Ä¶ come√ßou com um som simples.\n" +
      "Uma coisa que atravessou o sil√™ncio.\n" +
      "Algo que despertou tudo.\n\n" +
      "Se voc√™ lembrar desse primeiro gesto, deste primeiro ‚Äúchamado‚Äù, a porta se abre.",
    password: "liga√ß√£o",
    hint: "Pense na a√ß√£o que come√ßou tudo.",
    text_after:
      "17 de novembro.\n\n" +
      "Existe um tipo de destino que n√£o desce do c√©u nem se anuncia em grandezas.\n" +
      "Ele simplesmente chama. √Äs vezes tarde da noite. √Äs vezes com uma voz que voc√™ nunca ouviu antes ‚Äî e que, ainda assim, parece familiar.\n\n" +
      "Naquela noite, voc√™ me ligou. E algo em mim‚Ä¶ acordou de verdade.\n\n" +
      "Foi o instante em que o mundo - o meu mundo ‚Äî deixou de ser cinza...\n" +
      "Foi quando o sil√™ncio ganhou forma,\n" +
      "quando o escuro deu passagem,\n" +
      "quando eu soube, sem entender por qu√™,\n" +
      "que aquela luz era diferente.\n\n" +
      "‚ÄúObrigado por ter me ligado...‚Äù\n" +
      "‚ÄúObrigada por me atender e n√£o ir dormir...‚Äù\n\n" +
      "Eu nunca esqueci.\n" +
      "Nunca vou esquecer.\n\n" +
      "Voc√™ foi o come√ßo de tudo."
  },

  {
    index: 2,
    date: "2025-11-18",
    label: "18/11",
    text_before:
      "Ontem o universo trope√ßou ‚Äî e me arrependo.\n" +
      "Algumas coisas come√ßam assim: fora do ritmo, fora da hora.\n" +
      "Hoje, por√©m, ele se ajusta.\n\n" +
      "Porque 18 nunca foi s√≥ um n√∫mero.\n" +
      "Foi uma porta, um marco, um jeito do tempo dizer: ‚Äúaqui, algo muda‚Äù.\n\n" +
      "Para abrir este dia, voc√™ precisa lembrar das tr√™s marcas que sempre foram nossas:\n" +
      "o dia que virou ritual,\n" +
      "o m√™s que virou mem√≥ria,\n" +
      "e o segredo silencioso que sempre nos acompanhou.\n\n" +
      "A combina√ß√£o que s√≥ existe quando √© voc√™ e eu‚Ä¶ abre o caminho.",
    password: "1805",
    hint: "Dia. M√™s. N√≥s.",
    text_after:
      "18 sempre foi um lugar, n√£o um n√∫mero.\n" +
      "Um ponto onde tudo se realinha ‚Äî mesmo quando parecia fora do eixo.\n\n" +
      "√â por isso que hoje importa tanto.\n" +
      "Porque hoje eu quis fazer do 18 aquilo que ele sempre foi pra gente:\n" +
      "um come√ßo limpo, intencional, cuidado.\n\n" +
      "E quando voc√™ digitou 1805, n√£o foi s√≥ uma senha.\n" +
      "Foi uma lembran√ßa ‚Äî nossa forma discreta de dizer que sabemos quem somos, e de onde come√ßamos.\n\n" +
      "O 17 trope√ßou.\n" +
      "O 18 acerta o passo.\n\n" +
      "E agora sim: come√ßa o que realmente quero entregar pra voc√™.\n" +
      "Com calma.\n" +
      "Com brilho.\n" +
      "Com presen√ßa.\n\n" +
      "Pressione play.\n" +
      "O resto, eu te mostro no caminho."
  },

  {
    index: 3,
    date: "2025-11-19",
    label: "19/11",
    text_before: "35 de 72\n10¬™ frase\nPalavra 4",
    password: "mine",
    hint: "Grey ‚Äî Cinza",
    text_after:
      "Come√ßou a perceber como esse lugar funciona, n√©?\n" +
      "Aqui dentro, cada dia tem um ritmo: alguns v√£o exigir calma, outros aten√ß√£o, outros s√≥‚Ä¶ sentir.\n\n" +
      "Quero te mostrar todas as camadas da sua intensidade\n" +
      "Cada pequeno enigma, cada detalhe, cada escolha‚Ä¶ √© uma parte do que eu sinto por voc√™.\n\n" +
      "E, princesa‚Ä¶\n" +
      "eu amo voc√™ de um jeito que nenhum c√≥digo, palavra ou gesto consegue explicar por completo."
  },
  { index: 4,  date:"2025-11-20", label:"20/11", text_before:"...", password:"p4", hint:"...", text_after:"..." },
  { index: 5,  date:"2025-11-21", label:"21/11", text_before:"...", password:"p5", hint:"...", text_after:"..." },
  { index: 6,  date:"2025-11-22", label:"22/11", text_before:"...", password:"p6", hint:"...", text_after:"..." },
  { index: 7,  date:"2025-11-23", label:"23/11", text_before:"...", password:"p7", hint:"...", text_after:"..." },
  { index: 8,  date:"2025-11-24", label:"24/11", text_before:"...", password:"p8", hint:"...", text_after:"..." },
  { index: 9,  date:"2025-11-25", label:"25/11", text_before:"...", password:"p9", hint:"...", text_after:"..." },
  { index:10,  date:"2025-11-26", label:"26/11", text_before:"...", password:"p10", hint:"...", text_after:"..." },
  { index:11,  date:"2025-11-27", label:"27/11", text_before:"...", password:"p11", hint:"...", text_after:"..." },
  { index:12,  date:"2025-11-28", label:"28/11", text_before:"...", password:"p12", hint:"...", text_after:"..." },
  { index:13,  date:"2025-11-29", label:"29/11", text_before:"...", password:"p13", hint:"...", text_after:"..." },
  { index:14,  date:"2025-11-30", label:"30/11", text_before:"...", password:"p14", hint:"...", text_after:"..." },
  { index:15,  date:"2025-12-01", label:"01/12", text_before:"...", password:"p15", hint:"...", text_after:"..." },
  { index:16,  date:"2025-12-02", label:"02/12", text_before:"...", password:"p16", hint:"...", text_after:"..." },
  { index:17,  date:"2025-12-03", label:"03/12", text_before:"...", password:"p17", hint:"...", text_after:"..." },
  { index:18,  date:"2025-12-04", label:"04/12", text_before:"...", password:"p18", hint:"...", text_after:"..." },
  { index:19,  date:"2025-12-05", label:"05/12", text_before:"...", password:"p19", hint:"...", text_after:"..." },
  { index:20,  date:"2025-12-06", label:"06/12", text_before:"...", password:"p20", hint:"...", text_after:"..." },
  { index:21,  date:"2025-12-07", label:"07/12", text_before:"...", password:"p21", hint:"...", text_after:"..." },
  { index:22,  date:"2025-12-08", label:"08/12", text_before:"...", password:"p22", hint:"...", text_after:"..." },
  { index:23,  date:"2025-12-09", label:"09/12", text_before:"...", password:"p23", hint:"...", text_after:"..." },
  { index:24,  date:"2025-12-10", label:"10/12", text_before:"...", password:"p24", hint:"...", text_after:"..." },
  { index:25,  date:"2025-12-11", label:"11/12", text_before:"...", password:"p25", hint:"...", text_after:"..." },
  { index:26,  date:"2025-12-12", label:"12/12", text_before:"...", password:"p26", hint:"...", text_after:"..." },
  { index:27,  date:"2025-12-13", label:"13/12", text_before:"...", password:"p27", hint:"...", text_after:"..." },
  { index:28,  date:"2025-12-14", label:"14/12", text_before:"...", password:"p28", hint:"...", text_after:"..." },
  { index:29,  date:"2025-12-15", label:"15/12", text_before:"...", password:"p29", hint:"...", text_after:"..." },
  { index:30,  date:"2025-12-16", label:"16/12", text_before:"...", password:"p30", hint:"...", text_after:"..." },

  { index:31, date:"2025-12-17", label:"17/12", text_before:"...", password:"vday", hint:"...", text_after:"..." }
];


/* ========== dayExtraMusic: key = day.index ========== */
const dayExtraMusic = {
  1: [
    {
      src: "body-on-fire.mp3",
      title: "SLAVES ‚Äî Body On Fire",
      cover: "body-on-fire-cover.jpg"
    }
  ],

  3: [
    {
      src: "sleep-token-mine.mp3",
      title: "Sleep Token ‚Äî Mine",
      cover: "mine-cover.jpg"
    },
    {
      src: "body-on-fire.mp3",
      title: "SLAVES ‚Äî Body On Fire",
      cover: "body-on-fire-cover.jpg"
    }
  ]
};


/* ========== Helpers ========= */
function parseLocalDateYMD(ymd){ const [y,m,d] = ymd.split('-').map(Number); return new Date(y,m-1,d,0,0,0,0); }
const STORAGE_KEY = "rosa_unlocked_cinematic_v3";
let unlockedSet = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"));

/* ========== GRID ========== */
const grid = document.getElementById("grid");
function createGrid(){
  grid.innerHTML = "";
  days.forEach((d,i)=>{
    const el = document.createElement("div");
    const today = new Date(); today.setHours(0,0,0,0);
    const dayDate = parseLocalDateYMD(d.date);
    const unlockedByTime = today >= dayDate;
    const alreadyUnlocked = unlockedSet.has(String(i));
    el.className = "day " + (unlockedByTime ? "unlocked" : "locked");

    if(alreadyUnlocked) el.classList.add("checked");
    el.dataset.index = i;

    el.innerHTML = `
  <div class="circle">${d.index}</div>
  <div class="label">${d.label}</div>
  <div class="check">‚úì</div>
`;

    grid.appendChild(el);
    setTimeout(()=> el.style.opacity = 1, i*30);
  });
}
createGrid();

/* ========== COUNTDOWN ========== */
const cdText = document.getElementById("cdText");
const target = parseLocalDateYMD("2025-12-17");
function updateCountdown(){ const now=new Date(); let diff=target-now; if(diff<0) diff=0; const daysLeft=Math.floor(diff/(1000*60*60*24)); const hours=Math.floor((diff%(1000*60*60*24))/(1000*60*60)); const mins=Math.floor((diff%(1000*60*60))/(1000*60)); cdText.textContent = `${daysLeft}d ${hours}h ${mins}m`; }
updateCountdown(); setInterval(updateCountdown,60000);

/* ========== MODAL ELEMENTS ========== */
const modalBack = document.getElementById("modalBack"), modal = document.getElementById("modal"), modalTitle = document.getElementById("modalTitle"), modalText = document.getElementById("modalText");
const albumBox = document.getElementById("albumBox"), albumArt = document.getElementById("albumArt"), albumTitle = document.getElementById("albumTitle");
const extraMusicBox = document.getElementById("extraMusicBox"), modalPlay = document.getElementById("modalPlay"), modalPrev = document.getElementById("modalPrev"), modalNext = document.getElementById("modalNext");
const passwordBox = document.getElementById("passwordBox"), passwordInput = document.getElementById("passwordInput");
const hintBox = document.getElementById("hintBox");
const btnConfirm = document.getElementById("btnConfirm"), btnClose = document.getElementById("btnClose");
const toast = document.getElementById("toast");

let currentIndex = null; // array index for the day opened in modal
let typeTimer = null;

/* ========== PLAYER (global) ========== */
const playerCard = document.getElementById("playerCard");
const playerCoverImg = document.getElementById("playerCoverImg");
const playerTrackTitle = document.getElementById("playerTrackTitle");
const playerTrackArtist = document.getElementById("playerTrackArtist");
const playerLockBadge = document.getElementById("playerLockBadge");
const playerPrev = document.getElementById("playerPrev");
const playerPlay = document.getElementById("playerPlay");
const playerNext = document.getElementById("playerNext");
const playerAudio = document.getElementById("playerAudio");

let playerList = null; // current list of tracks (array)
let playerListDayIndex = null; // which day.index this list belongs to
let playerPos = 0;
let isPlaying = false;

/* helper: get track list by array index (days array index) */
function getDayMusicByArrayIndex(arrayIndex){
  if(arrayIndex === null || arrayIndex === undefined) return null;
  const dayObj = days[arrayIndex];
  if(!dayObj) return null;
  const key = dayObj.index;
  return dayExtraMusic[key] || null;
}

/* load a list into global player (does NOT autoplay unless play() called) */
function loadPlayerList(list, dayIndexKey){
  if(!list || list.length === 0){
    playerList = null;
    playerListDayIndex = null;
    playerPos = 0;
    playerCoverImg.src = "";
    playerCoverImg.style.opacity = 0;
    playerTrackTitle.textContent = "Trilha bloqueada";
    playerTrackArtist.textContent = "‚Äî";
    playerCard.classList.remove("unlocked");
    playerLockBadge.style.display = "flex";
    return;
  }

  playerList = list;
  playerListDayIndex = dayIndexKey;
  playerPos = 0;

  // update UI with first track (no autoplay)
  const t = list[0];
  playerCoverImg.src = t.cover || "";
  playerCoverImg.style.opacity = t.cover ? 1 : 0;
  playerTrackTitle.textContent = t.title || "Faixa";
  playerTrackArtist.textContent = ""; // you can fill artist separately if desired
  playerCard.classList.add("unlocked");
  playerLockBadge.style.display = "none";

  // load audio source but do not play automatically (you requested B)
  playerAudio.src = t.src || "";
  playerAudio.pause();
  isPlaying = false;
  updatePlayIcon();
}

/* play/pause */
function togglePlayerPlay(){
  if(!playerList){ showToast("Trilha bloqueada"); return; }
  if(!isPlaying){
    playerAudio.play().catch(()=>{ showToast("Navegador bloqueou o √°udio. Permita som."); });
    isPlaying = true;
  } else {
    playerAudio.pause();
    isPlaying = false;
  }
  updatePlayIcon();
}

function updatePlayIcon(){
  if(isPlaying){
    playerPlay.innerHTML = `
      <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <rect x="6" y="4" width="4" height="16"/>
        <rect x="14" y="4" width="4" height="16"/>
      </svg>`;
  } else {
    playerPlay.innerHTML = `
      <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 3v18l15-9L5 3z"/>
      </svg>`;
  }
}


function applyTrackToPlayer(t, autoplay=true){
  playerAudio.src = t.src;
  if(autoplay){
    playerAudio.play().catch(()=>{});
    isPlaying = true;
  }
  updatePlayIcon();

  playerCoverImg.src = t.cover || "";
  playerCoverImg.style.opacity = t.cover ? 1 : 0;
  playerTrackTitle.textContent = t.title || "Faixa";
  playerTrackArtist.textContent = t.artist || ""; // opcional
}

function playerNextTrack(){
  if(!playerList) return;
  playerPos = (playerPos + 1) % playerList.length;
  applyTrackToPlayer(playerList[playerPos], true);
}

function playerPrevTrack(){
  if(!playerList) return;
  playerPos = (playerPos - 1 + playerList.length) % playerList.length;
  applyTrackToPlayer(playerList[playerPos], true);
}


/* keep UI synced when audio ends */
playerAudio.addEventListener('ended', () => {
  // auto-advance
  if(playerList && playerList.length > 1){
    playerNextTrack();
  } else {
    isPlaying = false;
    updatePlayIcon();
  }
});

/* bind player buttons */
playerPlay.addEventListener("click", togglePlayerPlay);
playerPrev.addEventListener("click", playerPrevTrack);
playerNext.addEventListener("click", playerNextTrack);

/* ========== Typewriter effect for modal ========== */
function typeText(el, text, speed=22, done){
  if(typeTimer){ clearTimeout(typeTimer); typeTimer=null; }
  el.textContent = "";
  let i=0;
  function step(){ if(i < text.length){ el.textContent += text[i++]; typeTimer = setTimeout(step, speed); } else if(done){ done(); } }
  step();
}

/* ========== Modal open/close ========== */
function showModal(){ modalBack.style.display = "flex"; modalBack.setAttribute("aria-hidden","false"); }
function closeModal(){ modalBack.style.display = "none"; modalBack.setAttribute("aria-hidden","true"); currentIndex = null; if(typeTimer){ clearTimeout(typeTimer); typeTimer=null; } passwordBox.style.display = "block"; hintBox.style.display = "block"; btnConfirm.style.display = "inline-block"; albumBox.style.display = "none"; extraMusicBox.style.display = "none"; }

function openModal(i){
  currentIndex = i;
  const d = days[i];
  const alreadyUnlocked = unlockedSet.has(String(i));
  modalTitle.textContent = d.label;

  if(alreadyUnlocked){
    // always show final text AND music area if day has tracks
    const reveal = d.text_after || d.text || d.text_before || "Conte√∫do desbloqueado.";
    modalText.textContent = reveal;

    passwordBox.style.display = "none";
    hintBox.style.display = "none";
    btnConfirm.style.display = "none";

    // if day has music, populate modal music area (always when unlocked)
    const list = getDayMusicByArrayIndex(i);
    if(list){
      albumBox.style.display = "block";
      extraMusicBox.style.display = "block";
      albumArt.style.opacity = 0;
      albumArt.src = list[0].cover || "";
      albumTitle.textContent = list[0].title || "";
      setTimeout(()=> albumArt.style.opacity = 1, 30);
    } else {
      albumBox.style.display = "none";
      extraMusicBox.style.display = "none";
    }
    

    showModal();
    return;
  }

  // locked or first-time-open (but date allowed)
  typeText(modalText, d.text_before || d.text || "", 22);
  passwordInput.value = "";
  hintBox.textContent = d.hint || "";

  // hide music area until unlocked
  albumBox.style.display = "none";
  extraMusicBox.style.display = "none";

  passwordBox.style.display = "block";
  hintBox.style.display = "block";
  btnConfirm.style.display = "inline-block";

  showModal();
  setTimeout(()=> passwordInput.focus(), 200);
}

/* ========== Confirm/Unlock handling ========== */
btnConfirm.addEventListener("click", ()=>{
  if(currentIndex === null) return;
  const d = days[currentIndex];
  const typed = (passwordInput.value || "").trim().toLowerCase();
  if(!d.password){ unlockDay(currentIndex); return; }
  if(typed === d.password.toLowerCase()){
    unlockDay(currentIndex);
  } else {
    showToast("‚úñ Senha incorreta");
    passwordInput.focus();
  }
});

function unlockDay(i){
  const d = days[i];
  const dayEl = document.querySelector(`.day[data-index="${i}"]`);
  if(dayEl) dayEl.classList.add("checked");
  unlockedSet.add(String(i));
  localStorage.setItem(STORAGE_KEY, JSON.stringify([...unlockedSet]));

  // update modal
  modalTitle.textContent = `${d.label} ‚Äî Desbloqueado üíó`;
  modalText.textContent = d.text_after || d.hint || d.text_before || "";

  // if day has music, show and load into player (but DO NOT autoplay per your choice)
  const list = getDayMusicByArrayIndex(i);
  if(list){
    albumBox.style.display = "block";
    extraMusicBox.style.display = "block";
    albumArt.style.opacity = 0;
    albumArt.src = list[0].cover || "";
    albumTitle.textContent = list[0].title || "";
    setTimeout(()=> albumArt.style.opacity = 1, 30);

    // load into global player but do not play automatically (you answered B)
    loadPlayerList(list, days[i].index);
    // visual unlock glow on player
    playerCard.classList.add("unlocked");
    spawnUnlockGlow(playerCard);
  }

  passwordBox.style.display = "none";
  hintBox.style.display = "none";
  btnConfirm.style.display = "none";

  showToast("‚úî Senha correta");
  spawnSparklesAt(dayEl);
}

/* ========== Modal music controls should control the same global player ========= */
modalPlay.addEventListener("click", ()=> {
  // if modal corresponds to a day with music, set player to that day if not already
  if(currentIndex === null) return;
  const list = getDayMusicByArrayIndex(currentIndex);
  if(!list){ showToast("Sem trilha para este dia."); return; }
  // if player has different list loaded, load (but do not autoplay unless we want to start)
  if(playerListDayIndex !== days[currentIndex].index){
    loadPlayerList(list, days[currentIndex].index);
  }
  // toggle play/pause
  togglePlayerPlay();
});
modalNext.addEventListener("click", ()=> {
  const list = getDayMusicByArrayIndex(currentIndex);
  if(!list) return;
  if(playerListDayIndex !== days[currentIndex].index) loadPlayerList(list, days[currentIndex].index);
  playerNextTrack();
});
modalPrev.addEventListener("click", ()=> {
  const list = getDayMusicByArrayIndex(currentIndex);
  if(!list) return;
  if(playerListDayIndex !== days[currentIndex].index) loadPlayerList(list, days[currentIndex].index);
  playerPrevTrack();
});

/* ========== Grid click behavior ========= */
grid.addEventListener("click", ev => {
  const dayEl = ev.target.closest(".day");
  if(!dayEl) return;
  const i = Number(dayEl.dataset.index);
  if(isNaN(i)) return;
  const d = days[i];
  const dayDate = parseLocalDateYMD(d.date);
  const today = new Date(); today.setHours(0,0,0,0);

  if(today < dayDate){
    modalTitle.textContent = "Ainda trancado";
    modalText.textContent = "O tempo ainda n√£o permite ver este dia. Espere um pouco mais, meu bem.";
    passwordBox.style.display = "none"; hintBox.style.display = "none"; btnConfirm.style.display = "none";
    albumBox.style.display = "none"; extraMusicBox.style.display = "none";
    showModal();
    return;
  }
  openModal(i);
});

/* ========== open/close modal bindings ========= */
document.getElementById("closeModal").addEventListener("click", closeModal);
btnClose.addEventListener("click", closeModal);
document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeModal(); });

/* ========== Sparkles & unlock glow ========= */
function spawnSparklesAt(el){
  if(!el) return;
  const rect = el.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  const canvas = document.createElement("canvas");
  canvas.width = innerWidth; canvas.height = innerHeight;
  canvas.style.position = "fixed"; canvas.style.left = "0"; canvas.style.top = "0"; canvas.style.pointerEvents = "none"; canvas.style.zIndex = "9999";
  document.body.appendChild(canvas);
  const ctx = canvas.getContext("2d");
  const particles = []; const count = 22;
  for(let i=0;i<count;i++){
    particles.push({ x:cx, y:cy, vx:(Math.random()-0.5)*3, vy:(Math.random()-0.8)*3, r:Math.random()*2+1, life:Math.random()*40+20, color: Math.random()>0.5 ? "rgba(207,163,224,1)" : "rgba(246,215,166,1)" });
  }
  let frame=0;
  function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const p of particles){
      p.x += p.vx; p.y += p.vy; p.vy += 0.04; p.life--;
      const opacity = Math.max(0, p.life/60);
      ctx.beginPath(); ctx.fillStyle = p.color.replace("1)", `${opacity})`); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    }
    frame++;
    if(frame < 80){ requestAnimationFrame(loop); } else { canvas.remove(); }
  }
  loop();
}
function spawnUnlockGlow(el){
  el.animate([{ boxShadow: '0 0 0 rgba(212,160,255,0)' }, { boxShadow: '0 12px 40px rgba(212,160,255,0.12)' }, { boxShadow: '0 0 0 rgba(212,160,255,0)' }], { duration: 900 });
}

/* ========== Toast ========= */
function showToast(msg="‚úî"){ toast.textContent = msg; toast.classList.add("show"); setTimeout(()=> toast.classList.remove("show"), 1600); }

/* ========== Initialize state ========= */
// keep player locked unless a day with music was previously loaded
// If you previously unlocked a day with music and want it loaded on page load, detect that here:
(function initFromStorage(){
  // if any unlocked day has music, load the most recent unlocked with music (optional)
  const unlockedArr = [...unlockedSet].map(Number).sort((a,b)=>a-b);
  for(let k=unlockedArr.length-1;k>=0;k--){
    const idx = unlockedArr[k];
    const list = getDayMusicByArrayIndex(idx);
    if(list){ loadPlayerList(list, days[idx].index); break; }
  }
})();

/* ========== Simple stars/aurora/snow canvases (kept minimal) ========= */
const starsCanvas = document.getElementById("stars"), auroraCanvas = document.getElementById("aurora"), snowCanvas = document.getElementById("snow");
const sctx = starsCanvas.getContext("2d"), actx = auroraCanvas.getContext("2d"), nctx = snowCanvas.getContext("2d");
let DPR = Math.max(1, window.devicePixelRatio || 1), W = innerWidth, H = innerHeight;
function resizeAll(){ DPR = Math.max(1, window.devicePixelRatio || 1); W = innerWidth; H = innerHeight; [starsCanvas, auroraCanvas, snowCanvas].forEach(c=>{ c.width = Math.floor(W*DPR); c.height = Math.floor(H*DPR); c.style.width = W + "px"; c.style.height = H + "px"; }); sctx.setTransform(DPR,0,0,DPR,0,0); actx.setTransform(DPR,0,0,DPR,0,0); nctx.setTransform(DPR,0,0,DPR,0,0); initStars(); initSnow(); }
window.addEventListener("resize", resizeAll);

let stars = [];
function initStars(){ stars = []; const count = Math.max(120, Math.floor((W*H)/8000)); for(let i=0;i<count;i++){ stars.push({ x:Math.random()*W, y:Math.random()*H, r:Math.random()*1.4+0.3, alpha:Math.random()*0.8+0.2, phase:Math.random()*Math.PI*2 }); } }
function drawStars(){ sctx.clearRect(0,0,W,H); for(const st of stars){ st.phase += 0.01; const a = st.alpha * (0.5 + 0.5*Math.sin(st.phase)); sctx.beginPath(); sctx.fillStyle = Math.random()>0.9 ? `rgba(207,163,224,${a})` : `rgba(255,255,255,${a})`; sctx.arc(st.x,st.y,st.r,0,Math.PI*2); sctx.fill(); } requestAnimationFrame(drawStars); }

let aurPhase = 0;
function drawAurora(){ actx.clearRect(0,0,W,H); aurPhase += 0.0016; const gradient = actx.createLinearGradient(0, H*0.1, 0, H*0.4); gradient.addColorStop(0,"rgba(151,88,198,0.12)"); gradient.addColorStop(0.5,"rgba(233,160,119,0.04)"); gradient.addColorStop(1,"rgba(130,80,150,0)"); actx.fillStyle = gradient; actx.beginPath(); actx.moveTo(0,H*0.30); for(let x=0;x<=W;x+=55){ const y = H*0.28 + Math.sin((x*0.0038)+(aurPhase*3))*14; actx.lineTo(x,y); } actx.lineTo(W,H*0.30); actx.closePath(); actx.fill(); requestAnimationFrame(drawAurora); }

let flakes = [];
function initSnow(){ flakes = []; const isMobile = /iPhone|Android/i.test(navigator.userAgent); const count = isMobile ? 48 : 90; for(let i=0;i<count;i++){ flakes.push({ x:Math.random()*W, y:Math.random()*H, r:Math.random()*2.5+0.6, vx:(Math.random()-0.5)*0.3, vy:Math.random()*0.6+0.15, rot:Math.random()*Math.PI*2 }); } }
function drawSnow(){ nctx.clearRect(0,0,W,H); nctx.fillStyle = "rgba(255,255,255,0.9)"; for(const f of flakes){ nctx.beginPath(); nctx.arc(f.x,f.y,f.r,0,Math.PI*2); nctx.fill(); f.x += f.vx + Math.sin(f.rot)*0.12; f.y += f.vy; f.rot += 0.008; if(f.y > H+10){ f.y = -10; f.x = Math.random()*W; } if(f.x < -20){ f.x = W+20; } if(f.x > W+20){ f.x = -20; } } requestAnimationFrame(drawSnow); }

resizeAll(); drawStars(); drawAurora(); initSnow(); drawSnow();

</script>
</body>
</html>
