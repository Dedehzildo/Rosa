<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
<title>A Contagem da Rosa â€” CinemÃ¡tica (Optimized iPhone)</title>
<meta name="color-scheme" content="dark" />
<style>
  /* ===== Theme: mÃ­stico + luxo (Aurora leve) ===== */
  :root{
    --bg-deep:#06050a;
    --nebula-1: rgba(91,35,96,0.10);
    --nebula-2: rgba(134,54,131,0.06);
    --accent:#cfa3e0;
    --accent-2:#f6d7b1;
    --muted:#efeaf2;
    --card-bg: rgba(255,255,255,0.03);
    --glass: rgba(255,255,255,0.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    radial-gradient(1000px 600px at 10% 12%, var(--nebula-1), transparent 18%),
    radial-gradient(800px 420px at 92% 72%, var(--nebula-2), transparent 12%),
    linear-gradient(180deg,var(--bg-deep) 0%, #0b0b10 100%);
    color:var(--muted);font-family:Inter,system-ui,Roboto,Helvetica,Arial,-apple-system; -webkit-font-smoothing:antialiased;}
  body{min-height:100vh;padding-bottom:env(safe-area-inset-bottom);-webkit-tap-highlight-color:transparent}

  /* container */
  .wrap{width:100%;max-width:1100px;margin:0 auto;padding:24px 18px 120px;position:relative;z-index:10}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .title h1{margin:0;font-size:20px}
  .subtitle{margin-top:6px;color:rgba(239,234,242,0.78);font-size:13px}

  /* controls */
  .controls{display:flex;gap:12px;align-items:center}
  .count{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);font-size:13px;backdrop-filter: blur(4px)}
  .count .num{font-weight:700;color:var(--accent);margin-top:4px}
  #startMusic{padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,var(--accent),#a77bb7);border:0;color:#080206;font-weight:700;cursor:pointer}

  /* grid */
  main.grid{margin-top:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:12px;touch-action:manipulation}
  .day{aspect-ratio:1;border-radius:14px;background:linear-gradient(180deg,var(--card-bg), rgba(255,255,255,0.02));display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:visible;box-shadow:0 8px 30px rgba(2,6,23,0.55);transform:translateY(12px) scale(.995);opacity:0}
  .day.enter{animation:cardIn .44s cubic-bezier(.2,.8,.2,1) forwards}
  @keyframes cardIn{to{transform:none;opacity:1}}
  .circle{width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;background:linear-gradient(180deg, rgba(20,12,30,0.95), rgba(28,40,64,0.95));border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .label{margin-top:8px;font-size:12px;color:rgba(239,234,242,0.92);text-align:center;padding:0 6px}
  .day.locked{filter:grayscale(20%);opacity:.55}
  .day.unlocked{transition:box-shadow .3s,transform .22s}
  .day.checked{outline:2px solid rgba(246,215,166,0.05);box-shadow:0 14px 46px rgba(200,140,200,0.06)}
  .day .check{position:absolute;right:8px;top:8px;width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:var(--accent-2);color:#000;font-weight:700;transform:scale(0);transition:transform .22s}
  .day.checked .check{transform:scale(1)}
  .day:hover{transform:translateY(-6px);box-shadow:0 18px 60px rgba(0,0,0,0.65)}

  /* modal glass */
  .modalBack{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(rgba(2,3,6,0.6), rgba(2,3,6,0.82));z-index:220;padding:18px}
  .modal{width:100%;max-width:760px;border-radius:16px;padding:20px;background:linear-gradient(180deg, rgba(8,6,12,0.82), rgba(18,12,25,0.96));border:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(10px);box-shadow:0 30px 80px rgba(0,0,0,0.7);transform:translateY(10px) scale(.98);opacity:0}
  .modal.show{animation:modalIn .36s cubic-bezier(.2,.9,.2,1) forwards}
  @keyframes modalIn{to{transform:none;opacity:1}}
  .modal h2{margin:0;color:var(--accent)}
  .modal p{color:var(--muted);line-height:1.6;margin:10px 0}
  .passwordBox{margin-top:8px}
  .passwordBox input{width:100%;padding:12px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:var(--muted)}
  .hintBox{width:100%;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);color:var(--muted);min-height:58px}
  .btnRow{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#a77bb7);color:#0b0609;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

  /* toast */
  .toast{position:fixed;left:50%;transform:translateX(-50%) translateY(20px);bottom:28px;padding:10px 14px;border-radius:12px;background:rgba(0,0,0,0.6);color:var(--muted);z-index:400;opacity:0;transition:all .24s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* typing cursor */
  .type-cursor{display:inline-block;width:8px;height:18px;background:var(--accent);margin-left:6px;vertical-align:middle;animation:blink 1s steps(2) infinite}
  @keyframes blink{50%{opacity:0}}

  /* safety for iOS */
  button, input{ -webkit-appearance: none; }
  html,body{ -webkit-font-smoothing:antialiased; -webkit-text-size-adjust:100%}
  main.grid, .day { -webkit-transform: translateZ(0); will-change: transform, opacity; }
  .wrap{padding-top:calc(env(safe-area-inset-top) + 16px)}

  @media (max-width:720px){
    main.grid{grid-template-columns:repeat(3,1fr);gap:10px}
    .circle{width:52px;height:52px}
    .label{font-size:12px}
    .modal{padding:16px}
  }
</style>
</head>
<body>
  <!-- canvases: aurora (light), stars, snow -->
  <canvas id="aurora" style="position:fixed;left:0;top:0;pointer-events:none;z-index:3"></canvas>
  <canvas id="stars" style="position:fixed;left:0;top:0;pointer-events:none;z-index:2"></canvas>
  <canvas id="snow" style="position:fixed;left:0;top:0;pointer-events:none;z-index:4"></canvas>

  <div class="wrap" role="main">
    <header>
      <div class="title">
        <h1>ðŸŒ™ A Contagem da Rosa</h1>
        <div class="subtitle">HÃ¡ magias que nÃ£o precisam de feitiÃ§os â€” sÃ³ do tempo certo para florescer.</div>
      </div>
      <div class="controls" aria-hidden="false">
        <div class="count" aria-live="polite">
          <div style="font-size:12px;color:rgba(239,234,242,0.68)">contagem atÃ© 17 de dezembro</div>
          <div class="num" id="cdText">-- dias --</div>
        </div>
        <button id="startMusic" aria-label="Tocar mÃºsica">â–¶ MÃºsica</button>
      </div>
    </header>

    <main id="grid" class="grid" aria-label="CalendÃ¡rio do advento"></main>

    <div style="margin-top:18px;color:rgba(239,234,242,0.62);font-size:14px;max-width:1100px">
      Oi, meu bem...
    </div>
  </div>

  <!-- modal -->
  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" id="modal" role="dialog" aria-modal="true">
      <button id="closeModal" style="float:right;background:none;border:0;color:var(--muted);font-size:18px">âœ•</button>
      <h2 id="modalTitle">Dia</h2>
      <div id="modalBody">
        <p id="modalText"></p>
      </div>

      <div class="passwordBox" id="passwordBox">
        <label style="display:block;margin-bottom:6px;color:rgba(239,234,242,0.8)">Senha do dia</label>
        <input id="passwordInput" type="password" placeholder="Digite a senha" aria-label="Senha do dia" inputmode="text" />
      </div>

      <div style="height:10px"></div>

      <div id="hintContainer">
        <label style="display:block;margin-bottom:6px;color:rgba(239,234,242,0.8)">Dica</label>
        <div class="hintBox" id="hintBox" aria-live="polite"></div>
      </div>

      <div class="btnRow">
        <button class="btn ghost" id="btnClose">Fechar</button>
        <button class="btn primary" id="btnConfirm">Confirmar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">âœ” Senha correta</div>

  <!-- audio: keep local file or change -->
  <audio id="bgMusic" loop preload="auto" src="Slaves - Body on Fire (Music video) [trstPd6vs9U].mp3"></audio>

<script>
/* =========================
   DAYS (easy to edit) - keep these keys
   ========================= */
const days = [
  {"index":1,"date":"2025-11-17","label":"17/11","text":"Hoje, o tempo despertou.","password":"p1","hint":"Um pequeno comeÃ§o."},
  {"index":2,"date":"2025-11-18","label":"18/11","text":"O universo tem um hÃ¡bito curioso.","password":"p2","hint":"Observe os sinais."},
  {"index":3,"date":"2025-11-19","label":"19/11","text":"HÃ¡ dias que parecem durar segundos.","password":"p3","hint":"Respire fundo."},
  {"index":4,"date":"2025-11-20","label":"20/11","text":"Cada gesto teu Ã© uma estrela.","password":"p4","hint":"Luz em detalhes."},
  {"index":5,"date":"2025-11-21","label":"21/11","text":"Ã€s vezes o amor nÃ£o grita â€” ele sussurra.","password":"p5","hint":"O silÃªncio fala."},
  {"index":6,"date":"2025-11-22","label":"22/11","text":"HÃ¡ lugares que sÃ³ o amor conhece.","password":"p6","hint":"MemÃ³rias escondidas."},
  {"index":7,"date":"2025-11-23","label":"23/11","text":"Sete dias, sete luzes.","password":"p7","hint":"O nÃºmero sete."},
  {"index":8,"date":"2025-11-24","label":"24/11","text":"Recordei uma conversa nossa.","password":"p8","hint":"Palavras em chuva."},
  {"index":9,"date":"2025-11-25","label":"25/11","text":"HÃ¡ um diamante oculto em cada escolha.","password":"p9","hint":"Escolha com carinho."},
  {"index":10,"date":"2025-11-26","label":"26/11","text":"Lembra do nosso primeiro riso alto?","password":"p10","hint":"Ria outra vez."},
  {"index":11,"date":"2025-11-27","label":"27/11","text":"As estrelas guardam lembranÃ§as.","password":"p11","hint":"Olhe pra cima."},
  {"index":12,"date":"2025-11-28","label":"28/11","text":"Penso nas fases da lua como promessas.","password":"p12","hint":"Fases e promessas."},
  {"index":13,"date":"2025-11-29","label":"29/11","text":"Uma playlist antiga toca ao fundo.","password":"p13","hint":"Uma mÃºsica antiga."},
  {"index":14,"date":"2025-11-30","label":"30/11","text":"Desenhar o teu reflexo.","password":"p14","hint":"Jardins de certezas."},
  {"index":15,"date":"2025-12-01","label":"01/12","text":"Uma porta pequena em mim.","password":"p15","hint":"Portas pequenas."},
  {"index":16,"date":"2025-12-02","label":"02/12","text":"Alice entrou em um paÃ­s de maravilhas.","password":"p16","hint":"ChÃ¡ e caminhos."},
  {"index":17,"date":"2025-12-03","label":"03/12","text":"Hoje escrevo uma carta curta: obrigada.","password":"p17","hint":"Obrigado."},
  {"index":18,"date":"2025-12-04","label":"04/12","text":"Uma foto rasgada, uma polaroid amarelada.","password":"p18","hint":"Fotos antigas."},
  {"index":19,"date":"2025-12-05","label":"05/12","text":"Sinto o cheiro de vinho e lasanha.","password":"p19","hint":"Cheiros que lembram."},
  {"index":20,"date":"2025-12-06","label":"06/12","text":"No mapa que traÃ§o toda noite.","password":"p20","hint":"Curvas no mapa."},
  {"index":21,"date":"2025-12-07","label":"07/12","text":"O nÃºmero sete nos sorri.","password":"p21","hint":"Sete cores."},
  {"index":22,"date":"2025-12-08","label":"08/12","text":"Se o amor tivesse uma textura.","password":"p22","hint":"Veludo ao entardecer."},
  {"index":23,"date":"2025-12-09","label":"09/12","text":"Luz de vela, duas taÃ§as.","password":"p23","hint":"Brinde breve."},
  {"index":24,"date":"2025-12-10","label":"10/12","text":"Um pequeno enigma: feche os olhos.","password":"p24","hint":"Conte respiraÃ§Ãµes."},
  {"index":25,"date":"2025-12-11","label":"11/12","text":"Na danÃ§a das horas encontrei compasso.","password":"p25","hint":"Ritmo lento."},
  {"index":26,"date":"2025-12-12","label":"12/12","text":"HÃ¡ um pingente que carrego em memÃ³ria.","password":"p26","hint":"SÃ­mbolos antigos."},
  {"index":27,"date":"2025-12-13","label":"13/12","text":"As fases da lua me lembram de ti.","password":"p27","hint":"Fases: inteira/traÃ§o."},
  {"index":28,"date":"2025-12-14","label":"14/12","text":"Escrevo-te como quem fala ao vento.","password":"p28","hint":"Palavras ao vento."},
  {"index":29,"date":"2025-12-15","label":"15/12","text":"A reta final aproxima-se.","password":"p29","hint":"Cores intensas."},
  {"index":30,"date":"2025-12-16","label":"16/12","text":"Amanhecer de vÃ©spera: preparei surpresas.","password":"p30","hint":"Sete surpresas."},
  {"index":31,"date":"2025-12-17","label":"17/12","text":"Hoje o tempo se curva. Feliz aniversÃ¡rio, Rosa.","password":"vday","hint":"A data Ã© a chave."}
];

/* ========== helpers ========== */
function parseLocalDateYMD(ymd){ const [y,m,d] = ymd.split('-').map(Number); return new Date(y, m-1, d, 0,0,0,0); }
const STORAGE_KEY = 'rosa_unlocked_cinematic_v1';
let unlockedSet = new Set(JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'));

/* ========== grid render with stagger ========== */
const grid = document.getElementById('grid');
function createGrid(){
  grid.innerHTML = '';
  days.forEach((d,i)=>{
    const el = document.createElement('div');
    const today = new Date(); today.setHours(0,0,0,0);
    const dayDate = parseLocalDateYMD(d.date);
    const unlockedByTime = today >= dayDate;
    const isChecked = unlockedSet.has(String(i));
    el.className = unlockedByTime ? 'day unlocked' : 'day locked';
    if(isChecked) el.classList.add('checked');
    el.dataset.index = i;
    el.innerHTML = `<div class="circle">${d.index}</div><div class="label">${d.label}</div><div class="check">âœ“</div>`;
    grid.appendChild(el);
    setTimeout(()=> el.classList.add('enter'), i*35);
  });
}
createGrid();

/* ========== countdown ========== */
const cdText = document.getElementById('cdText');
const target = parseLocalDateYMD('2025-12-17');
function updateCountdown(){
  const now = new Date(); let diff = target - now; if(diff < 0) diff = 0;
  const daysLeft = Math.floor(diff / (1000*60*60*24));
  const hours = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
  const mins = Math.floor((diff % (1000*60*60)) / (1000*60));
  cdText.textContent = `${daysLeft}d ${hours}h ${mins}m`;
}
updateCountdown(); setInterval(updateCountdown, 30*1000);

/* ========== modal & typing ========== */
const modalBack = document.getElementById('modalBack');
const modal = document.getElementById('modal');
const modalTitle = document.getElementById('modalTitle');
const modalText = document.getElementById('modalText');
const passwordInput = document.getElementById('passwordInput');
const passwordBox = document.getElementById('passwordBox');
const hintBox = document.getElementById('hintBox');
const hintContainer = document.getElementById('hintContainer');
const btnConfirm = document.getElementById('btnConfirm');
const btnClose = document.getElementById('btnClose');
const closeModalBtn = document.getElementById('closeModal');
const toast = document.getElementById('toast');

let currentIndex = null;
let typeTimer = null;

function typeText(el, text, speed=20, done){
  if(typeTimer){ clearTimeout(typeTimer); typeTimer=null; }
  el.textContent = ''; let i=0;
  function step(){ if(i<text.length){ el.textContent += text[i++]; typeTimer = setTimeout(step, speed); } else if(done) done(); }
  step();
}

function showModal(){ modalBack.style.display='flex'; modalBack.setAttribute('aria-hidden','false'); modal.classList.add('show'); }
function closeModal(){ modalBack.style.display='none'; modalBack.setAttribute('aria-hidden','true'); modal.classList.remove('show'); currentIndex=null; if(passwordBox) passwordBox.style.display='block'; if(hintContainer) hintContainer.style.display='block'; if(btnConfirm) btnConfirm.style.display='inline-block'; if(typeTimer){ clearTimeout(typeTimer); typeTimer=null; } }

function openModal(i){
  currentIndex = i; const d = days[i];
  const dayEl = document.querySelector(`.day[data-index="${i}"]`);
  const isChecked = unlockedSet.has(String(i));
  if(isChecked){
    modalTitle.textContent = `${d.label} â€” Desbloqueado ðŸ’—`;
    const reveal = d.hint && d.hint.trim().length ? d.hint : d.text;
    modalText.textContent = reveal;
    if(passwordBox) passwordBox.style.display='none';
    if(hintContainer) hintContainer.style.display='none';
    if(btnConfirm) btnConfirm.style.display='none';
    showModal();
    return;
  }
  modalTitle.textContent = d.label;
  typeText(modalText, d.text, 20);
  if(passwordBox) passwordBox.style.display='block';
  if(hintContainer) hintContainer.style.display='block';
  if(btnConfirm) btnConfirm.style.display='inline-block';
  passwordInput.value=''; hintBox.textContent = d.hint || '';
  showModal();
  setTimeout(()=> passwordInput.focus(), 240);
}

/* confirm password */
btnConfirm.addEventListener('click', ()=>{
  if(currentIndex===null) return;
  const d = days[currentIndex]; const entered = (passwordInput.value||'').trim();
  if(d.password && d.password.length){
    if(entered.toLowerCase() === d.password.toLowerCase()){
      unlockedSet.add(String(currentIndex));
      localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(unlockedSet)));
      const dayEl = document.querySelector(`.day[data-index="${currentIndex}"]`);
      if(dayEl) dayEl.classList.add('checked');
      const reveal = d.hint && d.hint.trim().length ? d.hint : d.text;
      modalTitle.textContent = `${d.label} â€” Desbloqueado ðŸ’—`;
      modalText.textContent = reveal;
      if(passwordBox) passwordBox.style.display='none';
      if(hintContainer) hintContainer.style.display='none';
      if(btnConfirm) btnConfirm.style.display='none';
      spawnSparklesAt(dayEl);
      showToast('âœ” Senha correta');
    } else { showToast('âœ– Senha incorreta'); passwordInput.focus(); }
  } else { showToast('âœ” Sem senha â€” conteÃºdo liberado'); }
});

/* grid click */
grid.addEventListener('click', (ev)=>{
  const dayEl = ev.target.closest('.day'); if(!dayEl) return;
  const i = Number(dayEl.dataset.index); if(Number.isNaN(i)) return;
  const d = days[i]; const dayDate = parseLocalDateYMD(d.date);
  const today = new Date(); today.setHours(0,0,0,0);
  if(today >= dayDate) openModal(i);
  else {
    modalTitle.textContent = 'Ainda trancado';
    modalText.textContent = 'O tempo ainda nÃ£o permite ver este dia. Aguarde o toque da prÃ³xima lua.';
    if(passwordBox) passwordBox.style.display='none'; if(hintContainer) hintContainer.style.display='none'; if(btnConfirm) btnConfirm.style.display='none';
    passwordInput.value=''; showModal();
  }
});

/* keep unlocked by time updated */
setInterval(()=>{
  const today = new Date(); today.setHours(0,0,0,0);
  document.querySelectorAll('.day').forEach(el=>{
    const i = Number(el.dataset.index); const d = days[i]; const dayDate = parseLocalDateYMD(d.date);
    if(today >= dayDate) el.classList.add('unlocked');
  });
}, 60000);

/* modal close */
closeModalBtn.addEventListener('click', closeModal);
btnClose.addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

/* toast */
function showToast(msg='âœ” Senha correta'){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), 1600); }

/* ========== Audio Button (user requested: play/pause on button) ========== */
const bgMusic = document.getElementById('bgMusic');
const startMusicBtn = document.getElementById('startMusic');
let musicPlaying = false;
startMusicBtn.addEventListener('click', async ()=>{
  try{
    if(!musicPlaying){ await bgMusic.play(); musicPlaying = true; startMusicBtn.textContent='â¸ Parar'; }
    else { bgMusic.pause(); musicPlaying = false; startMusicBtn.textContent='â–¶ MÃºsica'; }
  }catch(err){ showToast('O navegador bloqueou o Ã¡udio â€” clique novamente.'); }
});
bgMusic.addEventListener('ended', ()=>{ musicPlaying=false; startMusicBtn.textContent='â–¶ MÃºsica'; });

/* ========== Particles (sparkles) lightweight for iPhone ========== */
function spawnSparklesAt(el){
  if(!el) return;
  playSparklesAtElement(el, {count:18, life:60});
}
function playSparklesAtElement(el, opts={count:18, life:60}){
  const rect = el.getBoundingClientRect(); const cx = rect.left + rect.width/2; const cy = rect.top + rect.height/2;
  const c = document.createElement('canvas'); c.style.position='fixed'; c.style.left='0'; c.style.top='0'; c.style.pointerEvents='none'; c.width = innerWidth; c.height = innerHeight; c.style.zIndex = 9999; document.body.appendChild(c);
  const ctx = c.getContext('2d'); const particles=[];
  for(let i=0;i<opts.count;i++){
    particles.push({x:cx,y:cy, vx:(Math.random()-0.5)*3, vy:(Math.random()-1.2)*-3, r:Math.random()*2+0.6, life:Math.random()*opts.life+20, color: Math.random()>0.55? 'rgba(246,215,166,1)' : 'rgba(207,163,224,1)'});
  }
  let frame=0;
  function step(){
    ctx.clearRect(0,0,c.width,c.height);
    for(const p of particles){
      p.x += p.vx; p.y += p.vy + (frame*0.002); p.vy += 0.03; p.life--; const a = Math.max(0, p.life/ (opts.life+20));
      ctx.beginPath(); ctx.fillStyle = `rgba(255,255,255,${a*0.06})`; ctx.arc(p.x,p.y,p.r*2.2,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.fillStyle = p.color.replace('1)', `${a})`); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    }
    frame++;
    if(frame < opts.life+30) requestAnimationFrame(step); else document.body.removeChild(c);
  }
  step();
}

/* ========== Canvases: stars, aurora (light), snow; responsive + DPR ========== */
const starsCanvas = document.getElementById('stars');
const auroraCanvas = document.getElementById('aurora');
const snowCanvas = document.getElementById('snow');
const sctx = starsCanvas.getContext('2d');
const actx = auroraCanvas.getContext('2d');
const nctx = snowCanvas.getContext('2d');

let DPR = Math.max(1, window.devicePixelRatio || 1);
let W = innerWidth, H = innerHeight;
function resizeAll(){
  DPR = Math.max(1, window.devicePixelRatio || 1);
  W = innerWidth; H = innerHeight;
  [starsCanvas, auroraCanvas, snowCanvas].forEach(c=>{
    c.width = Math.floor(W * DPR);
    c.height = Math.floor(H * DPR);
    c.style.width = W + 'px';
    c.style.height = H + 'px';
  });
  sctx.setTransform(DPR,0,0,DPR,0,0);
  actx.setTransform(DPR,0,0,DPR,0,0);
  nctx.setTransform(DPR,0,0,DPR,0,0);
  initStars(); initSnow();
}
window.addEventListener('resize', resizeAll);

/* Stars */
let stars = [];
function initStars(){
  stars = []; const count = Math.max(100, Math.floor((W*H)/9000));
  for(let i=0;i<count;i++) stars.push({x:Math.random()*W, y:Math.random()*H, r:Math.random()*1.6+0.2, alpha:Math.random()*0.8+0.2, phase:Math.random()*Math.PI*2});
}
function drawStars(){
  sctx.clearRect(0,0,W,H);
  for(const st of stars){ st.phase += 0.01; const a = st.alpha * (0.5 + 0.5*Math.sin(st.phase)); sctx.beginPath(); sctx.fillStyle = `rgba(255,255,255,${a})`; sctx.arc(st.x, st.y, st.r, 0, Math.PI*2); sctx.fill(); }
  requestAnimationFrame(drawStars);
}

/* Aurora - LIGHT (user chose A) */
let aurPhase = 0;
function drawAurora(){
  actx.clearRect(0,0,W,H);
  aurPhase += 0.0016;
  const gradient = actx.createLinearGradient(0, H*0.12, 0, H*0.38);
  gradient.addColorStop(0, 'rgba(151,88,198,0.08)');
  gradient.addColorStop(0.5, 'rgba(233,160,119,0.03)');
  gradient.addColorStop(1, 'rgba(130,80,150,0)');
  actx.fillStyle = gradient; actx.beginPath();
  actx.moveTo(0, H*0.32);
  for(let x=0;x<=W;x+=60){
    const y = H*0.30 + Math.sin((x*0.004)+aurPhase*3) * 10;
    actx.lineTo(x, y);
  }
  actx.lineTo(W, H*0.32); actx.closePath(); actx.fill();
  requestAnimationFrame(drawAurora);
}

/* Snow (light) */
let flakes = [];
function initSnow(){
  flakes = []; const isMobile = /Mobi|Android/i.test(navigator.userAgent);
  const count = isMobile ? 50 : 90;
  for(let i=0;i<count;i++) flakes.push({x:Math.random()*W, y:Math.random()*H, r:Math.random()*2.5 + 0.3, vx:(Math.random()-0.5)*0.3, vy:Math.random()*0.6+0.12, rot:Math.random()*Math.PI*2});
}
function drawSnow(){
  nctx.clearRect(0,0,W,H);
  nctx.fillStyle = 'rgba(255,255,255,0.9)';
  for(const f of flakes){
    nctx.beginPath(); nctx.arc(f.x, f.y, f.r, 0, Math.PI*2); nctx.fill();
    f.x += f.vx + Math.sin(f.rot)*0.12; f.y += f.vy; f.rot += 0.008;
    if(f.y > H + 10){ f.y = -10; f.x = Math.random()*W; }
    if(f.x < -30) f.x = W + 30; if(f.x > W + 30) f.x = -30;
  }
  requestAnimationFrame(drawSnow);
}

/* init everything */
resizeAll(); drawStars(); drawAurora(); drawSnow();

/* ========== small helper: revive unlocked state + mark time unlocked ========== */
function initUnlockedByTimeAndStorage(){
  const today = new Date(); today.setHours(0,0,0,0);
  document.querySelectorAll('.day').forEach(el=>{
    const i = Number(el.dataset.index); const d = days[i]; const dayDate = parseLocalDateYMD(d.date);
    if(today >= dayDate) el.classList.add('unlocked');
    if(unlockedSet.has(String(i))) el.classList.add('checked');
  });
}
initUnlockedByTimeAndStorage();

/* ========== minimal accessibility notes (tap handling optimized) ========== */
/* nothing extra; escape closes modal (already added) */

/* ========== convenience: small debug helper (uncomment for dev) ========== */
// localStorage.removeItem(STORAGE_KEY); unlockedSet = new Set(); createGrid(); initUnlockedByTimeAndStorage();

</script>
</body>
</html>
